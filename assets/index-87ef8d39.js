import{F as de,u as ue}from"./provide-42b5b9b7.js";import{I as me}from"./index-edb3b75f.js";import{P as ce}from"./index-bc51d386.js";import{I as pe}from"./index-e305157c.js";import{v as ve}from"./index-5f3889e7.js";import{d as y,i as fe,f as c,c as ge}from"./components-e9444427.js";import{d as ye,a as T,b as Q,X as he,w as be,W as X,r as V,n as Ve,Z,at as G,_ as we,p as F,ag as Re,f as v,h as f,M as C,F as Pe,ai as Ce,D as J,N as i,Q as $e,ah as Be,q as $,j as B,R as ke,O as Se,S as De}from"./vue-router.esm-bundler-de96f312.js";import{i as K,a as Y}from"./shared-f14f9930.js";const Ae={modelValue:{type:Array,default:()=>[]},accept:{type:String,default:"image/*"},capture:{type:[String,Boolean],default:void 0},multiple:{type:Boolean,default:!1},readonly:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},removable:{type:Boolean,default:!0},maxlength:{type:[Number,String]},maxsize:{type:[Number,String]},previewed:{type:Boolean,default:!0},ripple:{type:Boolean,default:!0},validateTrigger:{type:Array,default:()=>["onChange","onRemove"]},rules:{type:Array},hideList:{type:Boolean,default:!1},onBeforeRead:y(),onAfterRead:y(),onBeforeRemove:y(),onRemove:y(),onOversize:y(),"onUpdate:modelValue":y()},{n:Le,classes:Ue}=ge("uploader");let Te=0;const Fe=ye({name:"VarUploader",directives:{Ripple:ve},components:{VarIcon:me,VarPopup:ce,VarFormDetails:de},props:Ae,setup(e){const d=T(null),k=T(!1),S=T(null),z=Q(()=>{const{maxlength:a,modelValue:{length:n}}=e;return he(a)?`${n} / ${a}`:""}),{form:s,bindForm:w}=ue(),{errorMessage:D,validateWithTrigger:A,validate:R,resetValidation:l}=fe(),g=Q(()=>{const{modelValue:a,hideList:n}=e;return n?[]:a}),_=()=>{d.value.click()},x=a=>{const{disabled:n,readonly:r,previewed:t}=e;if(s!=null&&s.disabled.value||s!=null&&s.readonly.value||n||r||!t)return;const{url:o}=a;if(X(o)&&Y(o)){pe(o);return}X(o)&&K(o)&&(S.value=a,k.value=!0)},ee=a=>({id:Te++,url:"",cover:"",name:a.name,file:a}),ae=a=>{const n=a.target,{files:r}=n;return Array.from(r)},le=a=>new Promise(n=>{const r=new FileReader;r.onload=()=>{const t=r.result;a.file.type.startsWith("image")&&(a.cover=t),a.url=t,n(a)},r.readAsDataURL(a.file)}),se=a=>a.map(le),ne=a=>{const{onBeforeRead:n}=e;return a.map(r=>new Promise(t=>{n||t({valid:!0,varFile:r});let o=c(n,V(r));o=G(o)?o:[o],Promise.all(o).then(h=>{t({valid:!h.some(b=>!b),varFile:r})})}))},re=async a=>{const{maxsize:n,maxlength:r,modelValue:t,onOversize:o,onAfterRead:h,readonly:b,disabled:m}=e;if(s!=null&&s.disabled.value||s!=null&&s.readonly.value||m||b)return;const U=u=>u.filter(P=>P.file.size>Z(n)?(c(o,V(P)),!1):!0),te=u=>{const P=Math.min(u.length,Z(r)-t.length);return u.slice(0,P)};let p=ae(a).map(ee);p=n!=null?U(p):p,p=r!=null?te(p):p;const ie=await Promise.all(se(p)),q=(await Promise.all(ne(ie))).filter(({valid:u})=>u).map(({varFile:u})=>u);c(e["onUpdate:modelValue"],[...t,...q]),a.target.value="",q.forEach(u=>c(h,V(u)))},oe=async a=>{const{disabled:n,readonly:r,modelValue:t,onBeforeRemove:o,onRemove:h}=e;if(s!=null&&s.disabled.value||s!=null&&s.readonly.value||n||r)return;if(o){let m=c(o,V(a));if(m=G(m)?m:[m],(await Promise.all(m)).some(U=>!U))return}const b=t.filter(m=>m!==a);c(h,V(a)),H("onRemove"),c(e["onUpdate:modelValue"],b)},M=()=>e.modelValue.filter(a=>a.state==="success"),I=()=>e.modelValue.filter(a=>a.state==="error"),W=()=>e.modelValue.filter(a=>a.state==="loading"),E={getSuccess:M,getError:I,getLoading:W},H=a=>{Ve(()=>{const{validateTrigger:n,rules:r,modelValue:t}=e;A(n,a,r,t,E)})};let L=!1;const O=()=>R(e.rules,e.modelValue,E),j=()=>{L=!0,c(e["onUpdate:modelValue"],[]),l()};return c(w,{validate:O,resetValidation:l,reset:j}),be(()=>e.modelValue,()=>{!L&&H("onChange"),L=!1},{deep:!0}),{n:Le,classes:Ue,input:d,files:g,showPreview:k,currentPreview:S,errorMessage:D,maxlengthText:z,isHTMLSupportVideo:K,isHTMLSupportImage:Y,formDisabled:s==null?void 0:s.disabled,formReadonly:s==null?void 0:s.readonly,preview:x,triggerAction:_,handleChange:re,handleRemove:oe,getSuccess:M,getError:I,getLoading:W,validate:O,resetValidation:l,reset:j}}});const Ne=["onClick"],ze=["onClick"],Me=["src","alt"],Ie=["multiple","accept","capture","disabled"],We=["src"];function Ee(e,d,k,S,z,s){const w=F("var-icon"),D=F("var-form-details"),A=F("var-popup"),R=Re("ripple");return v(),f("div",{class:i(e.classes(e.n(),e.n("$--box")))},[C("div",{class:i(e.n("file-list"))},[(v(!0),f(Pe,null,Ce(e.files,l=>J((v(),f("div",{class:i(e.classes(e.n("file"),e.n("$-elevation--2"),[l.state==="loading",e.n("--loading")])),key:l.id,onClick:g=>e.preview(l)},[C("div",{class:i(e.n("file-name"))},$e(l.name||l.url),3),e.removable?(v(),f("div",{key:0,class:i(e.n("file-close")),onClick:Be(g=>e.handleRemove(l),["stop"])},[$(w,{class:i(e.n("file-close-icon")),"var-uploader-cover":"",name:"delete"},null,8,["class"])],10,ze)):B("",!0),l.cover?(v(),f("img",{key:1,class:i(e.n("file-cover")),style:ke({objectFit:l.fit}),src:l.cover,alt:l.name},null,14,Me)):B("",!0),C("div",{class:i(e.classes(e.n("file-indicator"),[l.state==="success",e.n("--success")],[l.state==="error",e.n("--error")]))},null,2)],10,Ne)),[[R,{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple}]])),128)),!e.maxlength||e.modelValue.length<e.maxlength?J((v(),f("div",{key:0,class:i(e.classes([!e.$slots.default,`${e.n("action")} ${e.n("$-elevation--2")}`],[e.disabled||e.formDisabled,e.n("--disabled")])),onClick:d[1]||(d[1]=(...l)=>e.triggerAction&&e.triggerAction(...l))},[C("input",{ref:"input",class:i(e.n("action-input")),type:"file",multiple:e.multiple,accept:e.accept,capture:e.capture,disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly,onChange:d[0]||(d[0]=(...l)=>e.handleChange&&e.handleChange(...l))},null,42,Ie),Se(e.$slots,"default",{},()=>[$(w,{class:i(e.n("action-icon")),"var-uploader-cover":"",name:"plus"},null,8,["class"])])],2)),[[R,{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple||e.$slots.default}]]):B("",!0)],2),$(D,{"error-message":e.errorMessage,"extra-message":e.maxlengthText},null,8,["error-message","extra-message"]),$(A,{class:i(e.n("preview")),"var-uploader-cover":"",position:"center",show:e.showPreview,"onUpdate:show":d[2]||(d[2]=l=>e.showPreview=l),onClosed:d[3]||(d[3]=l=>e.currentPreview=null)},{default:De(()=>{var l,g;return[e.currentPreview&&e.isHTMLSupportVideo((l=e.currentPreview)==null?void 0:l.url)?(v(),f("video",{key:0,class:i(e.n("preview-video")),playsinline:"true","webkit-playsinline":"true","x5-playsinline":"true","x5-video-player-type":"h5","x5-video-player-fullscreen":"false",controls:"",src:(g=e.currentPreview)==null?void 0:g.url},null,10,We)):B("",!0)]}),_:1},8,["class","show"])],2)}const N=we(Fe,[["render",Ee]]);N.install=function(e){e.component(N.name,N)};export{N as U};
